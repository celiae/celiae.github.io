---
title: 数据库
excerpt: Mariadb 是以前 Mysql 项目独立出来的开源项目，常被发行版使用
toc: true
categories:
  - 系统
---
开发中遇到需要永久保存的数据，一定会使用数据库，数据库有非常多的选择，互联网最常见的数据库就有关系型数据库，内存数据库，具体的软件有MySQL，Redis。通用的则是SQL语句，尽管稍有差别，担还是最需要掌握的语言。工作中会涉及数据迁移，开发程序驱动交互。
## Mariadb

以Mariadb为例，Mariadb 是以前 Mysql 项目独立出来的开源项目，常被Linux包管理器釆用。

### 安装 Mariadb
在ArchLinux中安装Mariadb数据库。为了方便，少用sudo命令，选择直接登录root账号。
```bash
sudo su # root 提权
pacman -S mariadb # ArchLinux 上安装 Mariadb
```

### 初始化
安装完并不能直接使用，还需进一步配置。使用`mariadb-install-db`时，它会询问你的偏好，即使全默认也可以用。
```shell
mariadb-install-db \
--user=mysql\
--basedir=/usr \
--datadir=/var/utils/mysql # 启用进程之前做一些配置
```
激活并启用进程`systemctl enable --now mariadb`，没问题后`mysql -u root -p`以root用户进入Mariadb，因此时是root登录，所以不用密码。在Mariadb里创建一个新的用户。
```bash
CREATE USER 'monty'@'localhost' IDENTIFIED BY 'some_pass';  # 新建用户
GRANT ALL PRIVILEGES ON mydb.* TO 'monty'@'localhost';  # 给予权限
FLUSH PRIVILEGES; # 刷新先前的权限设置
```

如果需要修改密码，可以执行：
```bash
use mysql # 跳转到"mysql"数据库
flush privileges; # 刷新权限
ALTER USER 'celiae'@'localhost' IDENTIFIED BY 'new_password'; # 修改
```

### 重置 root 密码
root用户也是Mariadb里的最高用户，通常不用来交互数据。忘记root密码也可以重置。
```bash
systemctl stop mariadb  # 停止 Mariadb 进程
mysqld_safe --skip-grant-tables --skip-networking & # 启用 mysql 安全模式
```
`mysql -u root`连接进去更改密码
```bash
use mysql
flush privileges;
ALTER USER 'root'@'localhost' IDENTIFIED BY 'new_password';
exit
```

```bash
kill $(cat /var/utils/mysql/$HOSTNAME.pid)  # 杀掉安全模式进程
systemctl start mariadb # 启用 Mariadb 进程
```

## Mysql - Docker

有的发行版例如 ArchLinux 不提供 Mysql， 只提供 Mariadb， 当要下载 Mysql 时，可以用 Docker.

```bash
docker pull mysql # 下载最新 Mysql
```

## SQL技巧

### 查找替换

`\a\b\c\d\ => \a\b\c\`

1. 字段中字符串以 `\` 分隔
2. 头尾也有 `\`
3. 将最后一部分删除;

```sql
--select 测试查看是否修正正确
select replace(FILE_LOC,substring_index(FILE_LOC,'\',-2),'')as NEW_FILE_LOC from car.file;
```

对比原始字段内容,再update.

#### 子问题1

`",arfta,tarf,arft"; ','`

result: 3

1. 寻找字段中字符串中某个字符串的数量

```sql
--distinct 是为了区分各种数量,如果有其它数量,那么就不能简简单单删除最后一块了
select distinct(NUM) from
(
    select length(FILE_LOC)-length(replace(FILE_LOC,'\','')) as NUM
    from IS_ARCHIVE.IS_FILES
);
```

### 统计多表元组总数:

```sql
-- 用 union 只能连接
SELECT COUNT(0) AS TotalRows
FROM (
    SELECT id FROM Table1
    UNION
    SELECT id FROM Table2
    UNION
    SELECT id FROM Table3
    -- 添加更多表的 UNION 查询
) AS CombinedTables;
```